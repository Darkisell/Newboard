<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>DigiBoard v2</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#1a1f2e">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="DigiBoard">
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='20' fill='%234f8ef7'/%3E%3Ctext y='.9em' font-size='80' x='10'%3E‚úèÔ∏è%3C/text%3E%3C/svg%3E">
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#0d0f14; --sur:#161b26; --sur2:#1e2535; --bdr:#2a3450;
  --acc:#4f8ef7; --grn:#4fcd8e; --red:#e05a5a; --ylw:#f7d44f;
  --txt:#e8eaf0; --mut:#6b7a99;
}
*{box-sizing:border-box;margin:0;padding:0;}
html,body{width:100%;height:100%;overflow:hidden;background:var(--bg);color:var(--txt);font-family:'DM Sans',sans-serif;touch-action:none;}
#app{display:flex;flex-direction:column;height:100vh;width:100vw;}

/* TOPBAR */
#topbar{display:flex;align-items:center;gap:7px;padding:5px 10px;background:var(--sur);border-bottom:1px solid var(--bdr);flex-shrink:0;z-index:50;}
.logo{font-family:'Space Mono',monospace;font-size:13px;font-weight:700;color:var(--acc);white-space:nowrap;}
.vs{width:1px;height:22px;background:var(--bdr);flex-shrink:0;}
.tbtn{padding:4px 10px;border-radius:6px;border:1px solid var(--bdr);background:transparent;color:var(--txt);font-size:12px;cursor:pointer;font-family:'DM Sans',sans-serif;transition:all .12s;white-space:nowrap;}
.tbtn:hover{border-color:var(--acc);color:var(--acc);}
.tbtn.pri{background:var(--acc);border-color:var(--acc);color:#fff;}
.tbtn.pri:hover{background:#3a7ae0;}
.tbtn.dng{border-color:var(--red);color:var(--red);}
.tbtn.dng:hover{background:var(--red);color:#fff;}
.sinfo{font-family:'Space Mono',monospace;font-size:11px;color:var(--mut);white-space:nowrap;}
.sp{flex:1;}

/* WACOM STATUS badge */
#wBadge{display:flex;align-items:center;gap:4px;padding:2px 8px;border-radius:10px;border:1px solid var(--bdr);font-size:11px;font-family:'Space Mono',monospace;transition:all .2s;}
#wBadge.conn{border-color:var(--grn);color:var(--grn);}
#wBadge.erasing{border-color:var(--red);color:var(--red);background:rgba(224,90,90,.12);}

/* TOOLBAR */
#toolbar{display:flex;align-items:center;gap:5px;padding:4px 10px;background:var(--sur2);border-bottom:1px solid var(--bdr);flex-shrink:0;flex-wrap:wrap;}
.tg{display:flex;align-items:center;gap:3px;}
.tool{width:30px;height:30px;border-radius:6px;border:1px solid transparent;background:transparent;color:var(--mut);cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;transition:all .1s;position:relative;flex-shrink:0;}
.tool:hover{background:var(--sur);color:var(--txt);border-color:var(--bdr);}
.tool.on{background:var(--acc);color:#fff;border-color:var(--acc);}
.tool.eon{background:var(--red)!important;color:#fff!important;border-color:var(--red)!important;}
.csw{width:22px;height:22px;border-radius:50%;cursor:pointer;border:2px solid transparent;transition:all .1s;flex-shrink:0;}
.csw:hover{transform:scale(1.15);}
.csw.on{border-color:#fff;transform:scale(1.2);box-shadow:0 0 0 1px var(--acc);}
#cpick{width:22px;height:22px;border-radius:50%;border:2px solid var(--bdr);cursor:pointer;background:transparent;padding:0;overflow:hidden;flex-shrink:0;}
.sl{font-size:10px;color:var(--mut);white-space:nowrap;}
input[type=range]{-webkit-appearance:none;height:4px;background:var(--bdr);border-radius:2px;outline:none;cursor:pointer;}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:12px;height:12px;background:var(--acc);border-radius:50%;}
#szSlider{width:65px;}#opSlider{width:55px;}#fsSlider{width:55px;}
.vl{font-size:10px;color:var(--mut);font-family:'Space Mono',monospace;min-width:24px;}
#txtOpts{display:none;align-items:center;gap:5px;}
#ffam{background:var(--sur);border:1px solid var(--bdr);color:var(--txt);border-radius:5px;padding:2px 4px;font-size:11px;cursor:pointer;}

/* TOOLTIP */
.tool[data-tip]:hover::after{content:attr(data-tip);position:absolute;bottom:calc(100% + 4px);left:50%;transform:translateX(-50%);background:#000;color:#fff;font-size:10px;padding:2px 6px;border-radius:4px;white-space:nowrap;pointer-events:none;font-family:'DM Sans',sans-serif;z-index:200;}

/* MAIN */
#main{display:flex;flex:1;overflow:hidden;}
#spanel{width:120px;background:var(--sur);border-right:1px solid var(--bdr);overflow-y:auto;padding:7px 5px;display:flex;flex-direction:column;gap:5px;flex-shrink:0;}
#spanel::-webkit-scrollbar{width:3px;}
#spanel::-webkit-scrollbar-thumb{background:var(--bdr);border-radius:2px;}
.sthumb{border-radius:5px;border:2px solid var(--bdr);overflow:hidden;cursor:pointer;transition:border-color .12s;position:relative;background:#fff;aspect-ratio:16/9;}
.sthumb:hover{border-color:var(--acc);}
.sthumb.on{border-color:var(--acc);box-shadow:0 0 0 2px rgba(79,142,247,.3);}
.sthumb canvas{width:100%;height:100%;display:block;}
.snum{position:absolute;bottom:2px;right:3px;font-size:8px;font-family:'Space Mono',monospace;color:#fff;background:rgba(0,0,0,.5);padding:1px 3px;border-radius:2px;}
.sacts{display:flex;gap:3px;}
.sacts button{flex:1;padding:5px;border:1px dashed var(--bdr);background:transparent;color:var(--mut);border-radius:5px;cursor:pointer;font-size:12px;transition:all .1s;}
.sacts button:hover{border-color:var(--acc);color:var(--acc);}

/* CANVAS */
#cwrap{flex:1;display:flex;align-items:center;justify-content:center;background:#12161f;overflow:hidden;position:relative;}
#bc{background:#fff;box-shadow:0 4px 32px rgba(0,0,0,.6);border-radius:3px;display:block;touch-action:none;cursor:crosshair;}
#ti{position:absolute;border:2px dashed var(--acc);background:rgba(255,255,255,.92);color:#111;font-size:18px;padding:4px 8px;outline:none;border-radius:4px;min-width:100px;min-height:30px;resize:both;overflow:auto;display:none;z-index:10;}
#cwrap.dragover::after{content:'Drop image here';position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:20px;color:var(--acc);background:rgba(79,142,247,.08);border:2px dashed var(--acc);border-radius:8px;pointer-events:none;}

/* ZOOM */
#zc{position:absolute;right:8px;bottom:8px;display:flex;flex-direction:column;gap:3px;z-index:20;}
#zc button{width:28px;height:28px;border-radius:6px;border:1px solid var(--bdr);background:var(--sur);color:var(--txt);font-size:15px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .1s;}
#zc button:hover{border-color:var(--acc);color:var(--acc);}
#zlbl{text-align:center;font-size:9px;font-family:'Space Mono',monospace;color:var(--mut);}

/* INDICATORS */
#eind,#hlind{position:fixed;pointer-events:none;z-index:9999;transform:translate(-50%,-50%);display:none;}
#eind{border-radius:50%;border:2px solid var(--red);opacity:.7;}
#hlind{border-radius:3px;opacity:.4;}

/* STATUS */
#sbar{display:flex;align-items:center;gap:10px;padding:3px 12px;background:var(--sur);border-top:1px solid var(--bdr);font-size:10px;color:var(--mut);font-family:'Space Mono',monospace;flex-shrink:0;}
.sdot{width:6px;height:6px;border-radius:50%;background:var(--grn);animation:pulse 2s infinite;}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}

/* MODAL */
#modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.65);z-index:999;align-items:center;justify-content:center;}
#modal.show{display:flex;}
.mbox{background:var(--sur);border:1px solid var(--bdr);border-radius:10px;padding:18px;width:310px;color:var(--txt);}
.mbox h3{font-size:14px;margin-bottom:12px;color:var(--acc);font-family:'Space Mono',monospace;}
.macts{display:flex;gap:7px;justify-content:flex-end;margin-top:10px;}
</style>
</head>
<body>
<div id="app">

<!-- TOPBAR -->
<div id="topbar">
  <div class="logo">‚úèÔ∏è DigiBoard <span style="font-size:9px;color:var(--mut)">v2</span></div>
  <div class="vs"></div>
  <span class="sinfo" id="sinfo">Slide 1/1</span>
  <button class="tbtn" onclick="prevSlide()">‚óÄ</button>
  <button class="tbtn" onclick="nextSlide()">‚ñ∂</button>
  <div class="sp"></div>
  <div id="wBadge">üñäÔ∏è Wacom</div>
  <div class="vs"></div>
  <button class="tbtn" onclick="saveImg()">üíæ Save</button>
  <button class="tbtn pri" onclick="togglePresent()">üñ•Ô∏è Present</button>
  <button class="tbtn dng" onclick="clearCanvas()">üóëÔ∏è Clear</button>
  <button class="tbtn pri" id="instBtn" style="display:none;background:#4fcd8e;border-color:#4fcd8e">üì≤ Install</button>
</div>

<!-- TOOLBAR -->
<div id="toolbar">
  <div class="tg">
    <button class="tool on" id="t-pen"         data-tip="Pen (P)"          onclick="setTool('pen')">‚úèÔ∏è</button>
    <button class="tool"    id="t-highlighter" data-tip="Highlighter (H)"  onclick="setTool('highlighter')">üñçÔ∏è</button>
    <button class="tool"    id="t-marker"      data-tip="Marker (M)"       onclick="setTool('marker')">üñäÔ∏è</button>
    <button class="tool"    id="t-eraser"      data-tip="Eraser (E)"       onclick="setTool('eraser')">‚¨ú</button>
    <button class="tool"    id="t-line"        data-tip="Line (L)"         onclick="setTool('line')">‚ï±</button>
    <button class="tool"    id="t-rect"        data-tip="Rectangle (R)"    onclick="setTool('rect')">‚ñ≠</button>
    <button class="tool"    id="t-circle"      data-tip="Circle (C)"       onclick="setTool('circle')">‚óã</button>
    <button class="tool"    id="t-arrow"       data-tip="Arrow (A)"        onclick="setTool('arrow')">‚ûú</button>
    <button class="tool"    id="t-text"        data-tip="Text (T)"         onclick="setTool('text')">T</button>
    <button class="tool"    id="t-image"       data-tip="Add Image"        onclick="triggerImg()">üñºÔ∏è</button>
    <button class="tool"    id="t-select"      data-tip="Select/Move (S)"  onclick="setTool('select')">‚Üñ</button>
    <button class="tool"    id="t-laser"       data-tip="Laser Pointer"    onclick="setTool('laser')">üî¥</button>
  </div>
  <div class="vs"></div>
  <div class="tg" id="cgrp">
    <div class="csw on"  style="background:#111111"                                    onclick="setColor('#111111')"></div>
    <div class="csw"     style="background:#ffffff;outline:1px solid #555;outline-offset:1px" onclick="setColor('#ffffff')"></div>
    <div class="csw"     style="background:#4f8ef7" onclick="setColor('#4f8ef7')"></div>
    <div class="csw"     style="background:#f7714f" onclick="setColor('#f7714f')"></div>
    <div class="csw"     style="background:#4fcd8e" onclick="setColor('#4fcd8e')"></div>
    <div class="csw"     style="background:#f7d44f" onclick="setColor('#f7d44f')"></div>
    <div class="csw"     style="background:#c44ff7" onclick="setColor('#c44ff7')"></div>
    <div class="csw"     style="background:#f74f74" onclick="setColor('#f74f74')"></div>
    <div class="csw"     style="background:#4ff7f0" onclick="setColor('#4ff7f0')"></div>
    <input type="color" id="cpick" value="#111111" oninput="setColor(this.value)" title="Custom color">
  </div>
  <div class="vs"></div>
  <div class="tg" style="gap:5px">
    <span class="sl">Size</span>
    <input type="range" id="szSlider" min="1" max="60" value="4" oninput="updateSize(this.value)">
    <span class="vl" id="szVal">4</span>
  </div>
  <div class="vs"></div>
  <div class="tg" style="gap:5px">
    <span class="sl">Opacity</span>
    <input type="range" id="opSlider" min="5" max="100" value="100" oninput="updateOpacity(this.value)">
    <span class="vl" id="opVal">100%</span>
  </div>
  <div class="vs"></div>
  <div id="txtOpts">
    <span class="sl">Font</span>
    <input type="range" id="fsSlider" min="8" max="80" value="20" oninput="updateFontSize(this.value)">
    <span class="vl" id="fsVal">20</span>
    <select id="ffam" onchange="fontFam=this.value">
      <option value="DM Sans">Sans</option>
      <option value="Space Mono">Mono</option>
      <option value="Georgia">Serif</option>
      <option value="Arial">Arial</option>
    </select>
    <div class="vs"></div>
  </div>
  <div class="tg">
    <button class="tool" data-tip="Undo Ctrl+Z"  onclick="undo()">‚Ü©Ô∏è</button>
    <button class="tool" data-tip="Redo Ctrl+Y"  onclick="redo()">‚Ü™Ô∏è</button>
    <button class="tool" data-tip="Grid"     id="t-grid"  onclick="toggleGrid()">‚äû</button>
    <button class="tool" data-tip="Fill shapes" id="t-fill" onclick="toggleFill()">‚ñ™</button>
    <button class="tool" data-tip="Background"  onclick="openBg()">üé®</button>
  </div>
</div>

<!-- MAIN -->
<div id="main">
  <div id="spanel">
    <div class="sacts">
      <button onclick="addSlide()" title="New slide">Ôºã</button>
      <button onclick="delSlide()" title="Delete slide">‚úï</button>
    </div>
  </div>
  <div id="cwrap">
    <canvas id="bc"></canvas>
    <textarea id="ti" placeholder="Type... (Ctrl+Enter = done, Esc = cancel)"></textarea>
    <div id="zc">
      <button onclick="zIn()">Ôºã</button>
      <div id="zlbl">100%</div>
      <button onclick="zOut()">Ôºç</button>
      <button onclick="zReset()" title="Reset">‚ü≥</button>
    </div>
  </div>
</div>

<!-- STATUS -->
<div id="sbar">
  <div class="sdot"></div>
  <span id="coord">x:0 y:0</span>|
  <span id="tdisp">Pen</span>|
  <span id="cdisp">#111111</span>|
  <span id="wdisp">Wacom: detecting...</span>
  <span style="margin-left:auto">DigiBoard v2.0 ‚ú®</span>
</div>
</div>

<!-- INDICATORS -->
<div id="eind"></div>
<div id="hlind"></div>

<!-- HIDDEN -->
<input type="file" id="imgInp" accept="image/*" style="display:none" onchange="loadImg(event)">

<!-- MODAL -->
<div id="modal">
  <div class="mbox">
    <h3 id="mtitle"></h3>
    <div id="mbody"></div>
    <div class="macts">
      <button class="tbtn" onclick="closeMod()">Cancel</button>
      <button class="tbtn pri" onclick="modOk()">Apply</button>
    </div>
  </div>
</div>

<script>
// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ
const bc   = document.getElementById('bc');
const ctx  = bc.getContext('2d');
const wrap = document.getElementById('cwrap');
const ti   = document.getElementById('ti');
const eind = document.getElementById('eind');
const hlind= document.getElementById('hlind');

let tool='pen', color='#111111', sz=4, op=1, fontSize=20, fontFam='DM Sans';
let fillShapes=false, gridOn=false, bgColor='#ffffff';
let drawing=false, sx,sy, snap;
let undoSt=[], redoSt=[];
let slides=[], curS=0;
let presenting=false, zoom=1;
let imgs=[], selImg=null, dox,doy;
let wacomOn=false, penEraser=false, prevTool='pen';
let laserDots=[], laserTmr;

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
function initCanvas(){
  const W=wrap.clientWidth-4, H=wrap.clientHeight-4;
  let cw=W, ch=Math.round(W*9/16);
  if(ch>H){ch=H;cw=Math.round(H*16/9);}
  bc.width=cw; bc.height=ch;
  bc.style.width=cw+'px'; bc.style.height=ch+'px';
}
function startup(){
  initCanvas(); addSlide(true);
  window.addEventListener('resize',()=>{if(!presenting){saveThumb();initCanvas();restoreSlide();}});
}

// ‚îÄ‚îÄ TOOL ‚îÄ‚îÄ
function setTool(t, fromW=false){
  if(!fromW) prevTool = (t==='eraser')?prevTool:t;
  tool=t;
  document.querySelectorAll('.tool[id^="t-"]').forEach(e=>e.classList.remove('on','eon'));
  const el=document.getElementById('t-'+t);
  if(el){ if(t==='eraser') el.classList.add('eon'); else el.classList.add('on'); }
  document.getElementById('tdisp').textContent = t.charAt(0).toUpperCase()+t.slice(1);
  document.getElementById('txtOpts').style.display = t==='text'?'flex':'none';
  bc.style.cursor = t==='eraser'?'cell': t==='text'?'text': t==='select'?'default':'crosshair';
  if(t!=='text') commitText();
  updWacomUI();
}
function setColor(c){
  color=c;
  document.getElementById('cpick').value=c;
  document.querySelectorAll('.csw').forEach(s=>{
    const sc=s.style.background||s.style.backgroundColor;
    s.classList.toggle('on', sc===c);
  });
  document.getElementById('cdisp').textContent=c;
}
function updateSize(v){sz=parseInt(v);document.getElementById('szVal').textContent=v;}
function updateOpacity(v){op=parseInt(v)/100;document.getElementById('opVal').textContent=v+'%';}
function updateFontSize(v){fontSize=parseInt(v);document.getElementById('fsVal').textContent=v;}
function toggleFill(){fillShapes=!fillShapes;document.getElementById('t-fill').classList.toggle('on',fillShapes);}

// ‚îÄ‚îÄ POINTER EVENTS ‚îÄ‚îÄ
bc.addEventListener('pointerdown', pDown);
bc.addEventListener('pointermove', pMove);
bc.addEventListener('pointerup',   pUp);
bc.addEventListener('pointerleave',()=>{eind.style.display='none';hlind.style.display='none';});

function gpos(e){
  const r=bc.getBoundingClientRect();
  return{x:(e.clientX-r.left)*(bc.width/r.width), y:(e.clientY-r.top)*(bc.height/r.height), cx:e.clientX, cy:e.clientY};
}

// ‚îÄ‚îÄ WACOM DETECTION ‚îÄ‚îÄ
// Wacom eraser = button 5 (eraser end) OR buttons=32
// Wacom barrel button = buttons=2 (side button on pen)
function detectWacom(e){
  if(e.pointerType==='pen'){
    if(!wacomOn){
      wacomOn=true;
      document.getElementById('wBadge').classList.add('conn');
      document.getElementById('wdisp').textContent='Wacom: connected ‚úÖ';
    }
    // Eraser end of stylus OR barrel side button
    const isErEnd   = (e.button===5 || e.buttons===32);
    const isBarrel  = (e.buttons===2 || e.button===2);
    if(isErEnd || isBarrel){
      if(!penEraser){
        penEraser=true;
        prevTool=tool!=='eraser'?tool:prevTool;
        setTool('eraser',true);
      }
    } else {
      if(penEraser){ penEraser=false; setTool(prevTool,true); }
    }
    updWacomUI();
  }
}

function updWacomUI(){
  const b=document.getElementById('wBadge');
  const d=document.getElementById('wdisp');
  if(penEraser){ b.className='erasing'; b.textContent='‚¨ú Erasing'; d.textContent='Wacom: ERASER üî¥';}
  else if(wacomOn){ b.className='conn'; b.textContent='üñäÔ∏è Pen'; d.textContent='Wacom: pen ‚úÖ';}
}

function showInds(e,p){
  if(tool==='eraser'){
    eind.style.display='block'; hlind.style.display='none';
    const r=bc.getBoundingClientRect(), sc=r.width/bc.width;
    const s=sz*2*sc*2;
    eind.style.width=eind.style.height=s+'px';
    eind.style.left=e.clientX+'px'; eind.style.top=e.clientY+'px';
  } else if(tool==='highlighter'){
    hlind.style.display='block'; eind.style.display='none';
    const r=bc.getBoundingClientRect(), sc=r.width/bc.width;
    hlind.style.width=(sz*4*sc)+'px'; hlind.style.height=(sz*2*sc)+'px';
    hlind.style.left=e.clientX+'px'; hlind.style.top=e.clientY+'px';
    hlind.style.background=color;
  } else { eind.style.display='none'; hlind.style.display='none'; }
}

function pDown(e){
  e.preventDefault(); detectWacom(e);
  const p=gpos(e); sx=p.x; sy=p.y;
  if(tool==='text'){commitText();showTI(p.x,p.y,p.cx,p.cy);return;}
  if(tool==='laser'){drawing=true;snap=ctx.getImageData(0,0,bc.width,bc.height);doLaser(p.x,p.y);return;}
  if(tool==='select'){
    selImg=null;
    for(let i=imgs.length-1;i>=0;i--){
      const im=imgs[i];
      if(im.si===curS&&p.x>=im.x&&p.x<=im.x+im.w&&p.y>=im.y&&p.y<=im.y+im.h){
        selImg=im; dox=p.x-im.x; doy=p.y-im.y; break;
      }
    }
    drawing=true; return;
  }
  saveUndo(); drawing=true;
  snap=ctx.getImageData(0,0,bc.width,bc.height);
  ctx.globalAlpha=op;
  if(tool==='pen'||tool==='marker'){
    ctx.beginPath(); ctx.moveTo(sx,sy);
    ctx.strokeStyle=color;
    ctx.lineWidth=tool==='marker'?sz*2.5:sz;
    ctx.lineCap=ctx.lineJoin='round';
  }
  if(tool==='highlighter'){
    ctx.beginPath(); ctx.moveTo(sx,sy);
    ctx.strokeStyle=color; ctx.lineWidth=sz*4;
    ctx.lineCap='square'; ctx.lineJoin='round'; ctx.globalAlpha=0.35;
  }
}

function pMove(e){
  e.preventDefault(); detectWacom(e);
  const p=gpos(e);
  document.getElementById('coord').textContent=`x:${Math.round(p.x)} y:${Math.round(p.y)}`;
  showInds(e,p);
  if(!drawing) return;
  if(tool==='laser'){doLaser(p.x,p.y);return;}
  if(tool==='select'){ if(selImg){selImg.x=p.x-dox;selImg.y=p.y-doy;redrawImgs();} return;}
  if(tool==='pen'||tool==='marker'||tool==='highlighter'){ctx.lineTo(p.x,p.y);ctx.stroke();return;}
  if(tool==='eraser'){
    ctx.save(); ctx.globalAlpha=1; ctx.globalCompositeOperation='destination-out';
    ctx.beginPath(); ctx.arc(p.x,p.y,sz*2,0,Math.PI*2); ctx.fill(); ctx.restore(); return;
  }
  ctx.putImageData(snap,0,0);
  ctx.globalAlpha=op; ctx.strokeStyle=color; ctx.fillStyle=color;
  ctx.lineWidth=sz; ctx.lineCap=ctx.lineJoin='round';
  drawShape(tool,sx,sy,p.x,p.y,fillShapes);
}

function pUp(e){ if(e)e.preventDefault(); drawing=false; ctx.globalAlpha=1; selImg=null; clearLaser(); saveThumb(); }

function drawShape(t,x1,y1,x2,y2,fill){
  ctx.beginPath();
  if(t==='line'){ctx.moveTo(x1,y1);ctx.lineTo(x2,y2);ctx.stroke();}
  else if(t==='rect'){if(fill)ctx.fillRect(x1,y1,x2-x1,y2-y1);else ctx.strokeRect(x1,y1,x2-x1,y2-y1);}
  else if(t==='circle'){
    const rx=Math.abs(x2-x1)/2,ry=Math.abs(y2-y1)/2;
    const cx=Math.min(x2,x1)+rx,cy=Math.min(y2,y1)+ry;
    ctx.ellipse(cx,cy,rx,ry,0,0,Math.PI*2);
    if(fill)ctx.fill();else ctx.stroke();
  } else if(t==='arrow'){drawArrow(x1,y1,x2,y2);}
}

function drawArrow(x1,y1,x2,y2){
  const ang=Math.atan2(y2-y1,x2-x1), hl=Math.max(sz*4,14);
  ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(x2,y2);
  ctx.lineTo(x2-hl*Math.cos(ang-Math.PI/6),y2-hl*Math.sin(ang-Math.PI/6));
  ctx.lineTo(x2-hl*Math.cos(ang+Math.PI/6),y2-hl*Math.sin(ang+Math.PI/6));
  ctx.closePath(); ctx.fill();
}

// ‚îÄ‚îÄ LASER ‚îÄ‚îÄ
function doLaser(x,y){
  laserDots.push({x,y});
  if(laserDots.length>35) laserDots.shift();
  if(snap) ctx.putImageData(snap,0,0);
  laserDots.forEach((d,i)=>{
    const a=(i+1)/laserDots.length, r=5*a;
    ctx.beginPath(); ctx.arc(d.x,d.y,r,0,Math.PI*2);
    ctx.fillStyle=`rgba(255,50,50,${a})`; ctx.fill();
  });
  ctx.beginPath(); ctx.arc(x,y,7,0,Math.PI*2); ctx.fillStyle='rgba(255,80,80,.9)'; ctx.fill();
  ctx.beginPath(); ctx.arc(x,y,3,0,Math.PI*2); ctx.fillStyle='#fff'; ctx.fill();
}
function clearLaser(){
  if(tool!=='laser') return;
  clearTimeout(laserTmr);
  laserTmr=setTimeout(()=>{ laserDots=[]; restoreSlide(); },800);
}

// ‚îÄ‚îÄ TEXT ‚îÄ‚îÄ
function showTI(x,y,cx,cy){
  ti.style.display='block'; ti.style.left=cx+'px'; ti.style.top=cy+'px';
  ti.style.fontSize=fontSize+'px'; ti.style.fontFamily=fontFam; ti.style.color=color;
  ti._cx=x; ti._cy=y; ti.value='';
  requestAnimationFrame(()=>ti.focus());
}
function commitText(){
  if(ti.style.display==='none'||!ti.value.trim()){ti.style.display='none';return;}
  saveUndo();
  ctx.save(); ctx.font=`${fontSize}px ${fontFam}`; ctx.fillStyle=color; ctx.globalAlpha=op;
  ti.value.split('\n').forEach((ln,i)=>ctx.fillText(ln,ti._cx,ti._cy+fontSize*(i+1)));
  ctx.restore(); ti.style.display='none'; saveThumb();
}
ti.addEventListener('keydown',e=>{
  if(e.key==='Escape'){ti.value='';commitText();}
  if(e.key==='Enter'&&e.ctrlKey) commitText();
});

// ‚îÄ‚îÄ IMAGES ‚îÄ‚îÄ
function triggerImg(){ document.getElementById('imgInp').click(); }
function loadImg(ev){
  const f=ev.target.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=e=>{
    const img=new Image();
    img.onload=()=>{
      saveUndo();
      const sc=Math.min(bc.width*.55/img.width, bc.height*.55/img.height, 1);
      const w=img.width*sc, h=img.height*sc;
      imgs.push({img,x:(bc.width-w)/2,y:(bc.height-h)/2,w,h,si:curS});
      redrawImgs(); saveThumb();
    };
    img.src=e.target.result;
  };
  r.readAsDataURL(f); ev.target.value='';
}
wrap.addEventListener('dragover',e=>{e.preventDefault();wrap.classList.add('dragover');});
wrap.addEventListener('dragleave',()=>wrap.classList.remove('dragover'));
wrap.addEventListener('drop',e=>{
  e.preventDefault(); wrap.classList.remove('dragover');
  const f=e.dataTransfer.files[0]; if(!f||!f.type.startsWith('image/')) return;
  const r=new FileReader();
  r.onload=ev=>{
    const img=new Image();
    img.onload=()=>{
      saveUndo();
      const sc=Math.min(bc.width*.5/img.width, bc.height*.5/img.height, 1);
      const w=img.width*sc, h=img.height*sc;
      const p=gpos(e);
      imgs.push({img,x:p.x-w/2,y:p.y-h/2,w,h,si:curS});
      redrawImgs(); saveThumb();
    };
    img.src=ev.target.result;
  };
  r.readAsDataURL(f);
});
function redrawImgs(){
  if(slides[curS]?.imgData) ctx.putImageData(slides[curS].imgData,0,0);
  else{ctx.fillStyle=bgColor;ctx.fillRect(0,0,bc.width,bc.height);}
  imgs.filter(im=>im.si===curS).forEach(im=>ctx.drawImage(im.img,im.x,im.y,im.w,im.h));
  if(gridOn) drawGrid();
}

// ‚îÄ‚îÄ UNDO/REDO ‚îÄ‚îÄ
function saveUndo(){undoSt.push(ctx.getImageData(0,0,bc.width,bc.height));if(undoSt.length>50)undoSt.shift();redoSt=[];}
function undo(){if(!undoSt.length)return;redoSt.push(ctx.getImageData(0,0,bc.width,bc.height));ctx.putImageData(undoSt.pop(),0,0);saveThumb();}
function redo(){if(!redoSt.length)return;undoSt.push(ctx.getImageData(0,0,bc.width,bc.height));ctx.putImageData(redoSt.pop(),0,0);saveThumb();}

// ‚îÄ‚îÄ GRID ‚îÄ‚îÄ
function toggleGrid(){gridOn=!gridOn;document.getElementById('t-grid').classList.toggle('on',gridOn);restoreSlide();}
function drawGrid(){
  ctx.save(); ctx.strokeStyle='rgba(100,130,220,0.12)'; ctx.lineWidth=1;
  const s=40;
  for(let x=0;x<=bc.width;x+=s){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,bc.height);ctx.stroke();}
  for(let y=0;y<=bc.height;y+=s){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(bc.width,y);ctx.stroke();}
  ctx.restore();
}

// ‚îÄ‚îÄ SLIDES ‚îÄ‚îÄ
function addSlide(first){
  slides.push({imgData:null,bg:'#ffffff'});
  const idx=slides.length-1;
  const thumb=document.createElement('div');
  thumb.className='sthumb'; thumb.id='th'+idx;
  const tc=document.createElement('canvas'); thumb.appendChild(tc);
  const n=document.createElement('div'); n.className='snum'; n.textContent=idx+1; thumb.appendChild(n);
  thumb.addEventListener('click',()=>goSlide(idx));
  document.getElementById('spanel').appendChild(thumb);
  if(!first){saveThumb();goSlide(idx);}else goSlide(0);
}
function delSlide(){
  if(slides.length===1){alert('Need at least 1 slide!');return;}
  if(!confirm('Delete this slide?'))return;
  slides.splice(curS,1);
  imgs=imgs.filter(im=>im.si!==curS);
  imgs.forEach(im=>{if(im.si>curS)im.si--;});
  document.getElementById('th'+(slides.length)).remove();
  document.querySelectorAll('.sthumb').forEach((el,i)=>{
    el.id='th'+i; el.querySelector('.snum').textContent=i+1;
    el.onclick=()=>goSlide(i);
  });
  goSlide(Math.min(curS,slides.length-1));
}
function goSlide(idx){if(idx<0||idx>=slides.length)return;saveThumb();curS=idx;restoreSlide();updSlideUI();}
function saveThumb(){
  if(!slides[curS])return;
  slides[curS].imgData=ctx.getImageData(0,0,bc.width,bc.height);
  const th=document.getElementById('th'+curS); if(!th)return;
  const tc=th.querySelector('canvas');
  tc.width=th.clientWidth||106; tc.height=th.clientHeight||60;
  tc.getContext('2d').drawImage(bc,0,0,bc.width,bc.height,0,0,tc.width,tc.height);
}
function restoreSlide(){
  ctx.clearRect(0,0,bc.width,bc.height); ctx.fillStyle=bgColor; ctx.fillRect(0,0,bc.width,bc.height);
  if(slides[curS]?.imgData) ctx.putImageData(slides[curS].imgData,0,0);
  if(gridOn) drawGrid();
  imgs.filter(im=>im.si===curS).forEach(im=>ctx.drawImage(im.img,im.x,im.y,im.w,im.h));
  undoSt=[]; redoSt=[]; snap=null;
}
function updSlideUI(){
  document.querySelectorAll('.sthumb').forEach((t,i)=>t.classList.toggle('on',i===curS));
  document.getElementById('sinfo').textContent=`Slide ${curS+1}/${slides.length}`;
}
function prevSlide(){goSlide(curS-1);}
function nextSlide(){if(curS===slides.length-1)addSlide();else goSlide(curS+1);}

// ‚îÄ‚îÄ CLEAR ‚îÄ‚îÄ
function clearCanvas(){
  if(!confirm('Clear this slide?'))return;
  saveUndo(); imgs=imgs.filter(im=>im.si!==curS);
  ctx.clearRect(0,0,bc.width,bc.height); ctx.fillStyle=bgColor; ctx.fillRect(0,0,bc.width,bc.height);
  if(gridOn) drawGrid(); saveThumb();
}

// ‚îÄ‚îÄ BACKGROUND ‚îÄ‚îÄ
let modCb=null;
function openBg(){
  document.getElementById('mtitle').textContent='üé® Background';
  document.getElementById('mbody').innerHTML=`
    <div style="display:flex;gap:7px;flex-wrap:wrap;margin-bottom:10px;">
      ${['#ffffff','#f5f5f0','#fdf6e3','#e8f4e8','#1a1f2e','#0d1117','#111111','#f0e6d3'].map(c=>
        `<div style="width:30px;height:30px;background:${c};border-radius:5px;cursor:pointer;border:2px solid #555"
          onclick="document.getElementById('bgp').value='${c}'" title="${c}"></div>`).join('')}
    </div>
    <input type="color" id="bgp" value="${bgColor}" style="width:100%;height:36px;border-radius:6px;border:1px solid var(--bdr);cursor:pointer;">
  `;
  modCb=()=>{bgColor=document.getElementById('bgp').value;restoreSlide();saveThumb();};
  document.getElementById('modal').classList.add('show');
}
function closeMod(){document.getElementById('modal').classList.remove('show');}
function modOk(){if(modCb)modCb();closeMod();}

// ‚îÄ‚îÄ ZOOM ‚îÄ‚îÄ
function applyZ(){bc.style.transform=`scale(${zoom})`;document.getElementById('zlbl').textContent=Math.round(zoom*100)+'%';}
function zIn(){zoom=Math.min(zoom+0.1,3);applyZ();}
function zOut(){zoom=Math.max(zoom-0.1,0.3);applyZ();}
function zReset(){zoom=1;applyZ();}

// ‚îÄ‚îÄ PRESENT ‚îÄ‚îÄ
function togglePresent(){
  presenting=!presenting;
  ['topbar','toolbar','spanel','sbar'].forEach(id=>document.getElementById(id).style.display=presenting?'none':'');
  wrap.style.background=presenting?'#000':'#12161f';
  if(presenting){bc.style.maxWidth='100vw';bc.style.maxHeight='100vh';if(bc.requestFullscreen)bc.requestFullscreen().catch(()=>{});}
  else{bc.style.maxWidth='';bc.style.maxHeight='';if(document.exitFullscreen)document.exitFullscreen().catch(()=>{});}
}
document.addEventListener('fullscreenchange',()=>{if(!document.fullscreenElement&&presenting)togglePresent();});

// ‚îÄ‚îÄ SAVE ‚îÄ‚îÄ
function saveImg(){
  const a=document.createElement('a');
  a.download=`digiboard-${curS+1}.png`;
  a.href=bc.toDataURL('image/png'); a.click();
}

// ‚îÄ‚îÄ KEYBOARD ‚îÄ‚îÄ
document.addEventListener('keydown',e=>{
  if(e.target===ti) return;
  if(e.ctrlKey&&e.key==='z'){e.preventDefault();undo();}
  if(e.ctrlKey&&e.key==='y'){e.preventDefault();redo();}
  if(e.ctrlKey&&e.key==='s'){e.preventDefault();saveImg();}
  if(e.key==='ArrowRight') nextSlide();
  if(e.key==='ArrowLeft')  prevSlide();
  if(e.key==='Escape'){if(presenting)togglePresent();commitText();}
  const map={p:'pen',h:'highlighter',m:'marker',e:'eraser',l:'line',r:'rect',c:'circle',a:'arrow',t:'text',s:'select'};
  if(map[e.key]&&!e.ctrlKey) setTool(map[e.key]);
  if(e.key==='+'||e.key==='=') zIn();
  if(e.key==='-') zOut();
  if(e.key==='0') zReset();
  if(e.key==='Delete'&&selImg){imgs=imgs.filter(i=>i!==selImg);redrawImgs();saveThumb();}
});

// ‚îÄ‚îÄ PWA ‚îÄ‚îÄ
if('serviceWorker' in navigator) window.addEventListener('load',()=>navigator.serviceWorker.register('./sw.js').catch(()=>{}));
let dP=null;
window.addEventListener('beforeinstallprompt',e=>{e.preventDefault();dP=e;document.getElementById('instBtn').style.display='flex';});
document.getElementById('instBtn').addEventListener('click',async()=>{
  if(!dP)return; dP.prompt();
  const{outcome}=await dP.userChoice;
  if(outcome==='accepted'){document.getElementById('instBtn').textContent='‚úÖ Done!';setTimeout(()=>document.getElementById('instBtn').style.display='none',2000);}
  dP=null;
});
window.addEventListener('appinstalled',()=>document.getElementById('instBtn').style.display='none');

// ‚îÄ‚îÄ START ‚îÄ‚îÄ
startup();
</script>
</body>
</html>
